<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Papers Daily</title>
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --border: #30363d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #238636;
            --orange: #f0883e;
            --red: #da3633;
            --purple: #a371f7;
            --yellow: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; overflow: hidden; }
        
        .app { display: flex; height: 100vh; }
        
        /* Panels */
        .panel { display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .papers-panel { width: 380px; min-width: 200px; max-width: 600px; border-right: 1px solid var(--border); }
        .pdf-panel { flex: 1; min-width: 200px; background: var(--bg2); display: none; }
        .pdf-panel.open { display: flex; }
        .chat-panel { width: 400px; min-width: 250px; max-width: 700px; border-left: 1px solid var(--border); }
        
        /* Resizer */
        .resizer { width: 5px; background: transparent; cursor: col-resize; position: relative; flex-shrink: 0; }
        .resizer:hover, .resizer.dragging { background: var(--blue); }
        .resizer::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 3px; height: 30px; background: var(--border); border-radius: 2px; }
        
        /* Headers */
        .panel-header { padding: 10px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); flex-shrink: 0; }
        .panel-header h1 { font-size: 1em; }
        .panel-header h2 { font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        
        .search-sort { padding: 10px 14px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .search-box { width: 100%; padding: 8px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85em; margin-bottom: 8px; }
        .search-box:focus { outline: none; border-color: var(--blue); }
        .sort-row { display: flex; gap: 8px; }
        .sort-select { flex: 1; padding: 6px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.75em; cursor: pointer; }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg2); flex-shrink: 0; }
        .tab { padding: 8px 12px; font-size: 0.75em; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
        .tab .count { background: var(--bg3); padding: 1px 5px; border-radius: 6px; font-size: 0.7em; margin-left: 3px; }
        .tab.active .count { background: var(--blue); color: white; }
        
        /* Papers List */
        .papers-list { flex: 1; overflow-y: auto; }
        .paper { padding: 10px 14px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .paper:hover { background: var(--bg2); }
        .paper.selected { background: rgba(88,166,255,0.1); border-left: 3px solid var(--blue); }
        .paper-title { font-size: 0.85em; font-weight: 600; margin-bottom: 4px; line-height: 1.4; }
        .paper-meta { font-size: 0.7em; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 4px; }
        .paper-date { color: var(--orange); }
        .paper-score { padding: 2px 6px; border-radius: 6px; font-size: 0.65em; font-weight: 600; }
        .paper-score.high { background: var(--green); color: white; }
        .paper-score.medium { background: var(--blue); color: white; }
        .paper-score.low { background: var(--bg3); color: var(--text2); }
        .paper-actions { display: flex; gap: 4px; margin-top: 6px; }
        .paper-btn { padding: 3px 8px; font-size: 0.65em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text2); cursor: pointer; text-decoration: none; }
        .paper-btn:hover { background: var(--border); color: var(--text); }
        .paper-btn.primary { background: var(--blue); border-color: var(--blue); color: white; }
        .paper-btn.saved { background: var(--green); border-color: var(--green); color: white; }
        
        /* PDF Panel */
        .pdf-header { padding: 8px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); flex-shrink: 0; }
        .pdf-title { font-size: 0.8em; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .pdf-actions { display: flex; gap: 10px; align-items: center; }
        .pdf-actions a { font-size: 0.7em; color: var(--blue); text-decoration: none; }
        .close-btn { background: var(--bg3); border: 1px solid var(--border); color: var(--text); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
        .close-btn:hover { background: var(--red); border-color: var(--red); color: white; }
        .pdf-frame { flex: 1; border: none; background: #444; }
        
        /* Chat */
        .ai-status { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
        .chat-context { padding: 8px 14px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.75em; color: var(--text2); flex-shrink: 0; }
        .chat-context strong { color: var(--purple); }
        
        .chat-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        .msg { margin-bottom: 12px; display: flex; gap: 8px; }
        .msg-avatar { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65em; flex-shrink: 0; }
        .msg.user .msg-avatar { background: var(--blue); }
        .msg.ai .msg-avatar { background: var(--purple); }
        .msg-content { padding: 8px 12px; border-radius: 8px; font-size: 0.8em; line-height: 1.5; max-width: 90%; }
        .msg.user .msg-content { background: var(--blue); margin-left: auto; }
        .msg.ai .msg-content { background: var(--bg3); }
        
        .typing span { width: 6px; height: 6px; background: var(--text2); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite; margin-right: 3px; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-4px)} }
        
        /* Whiteboard */
        .whiteboard-section { border-top: 1px solid var(--border); flex-shrink: 0; }
        .whiteboard-header { padding: 8px 14px; background: var(--bg2); display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .whiteboard-header:hover { background: var(--bg3); }
        .whiteboard-header h3 { font-size: 0.8em; }
        .whiteboard-content { display: none; background: var(--bg); }
        .whiteboard-content.show { display: block; }
        .whiteboard-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .wb-tab { padding: 6px 12px; font-size: 0.7em; cursor: pointer; color: var(--text2); border-bottom: 2px solid transparent; }
        .wb-tab.active { color: var(--yellow); border-bottom-color: var(--yellow); }
        .wb-panel { display: none; }
        .wb-panel.active { display: block; }
        .whiteboard-canvas { width: 100%; height: 180px; background: #1a1a2e; cursor: crosshair; display: block; }
        .whiteboard-textarea { width: 100%; height: 180px; background: var(--bg2); border: none; color: var(--text); font-family: 'Monaco', monospace; font-size: 0.75em; padding: 10px; resize: none; }
        .whiteboard-textarea:focus { outline: none; }
        .wb-tools { padding: 6px 10px; display: flex; gap: 6px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        .wb-tool { padding: 4px 8px; font-size: 0.65em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text2); }
        .wb-tool:hover { background: var(--border); }
        .wb-tool.active { background: var(--yellow); color: black; border-color: var(--yellow); }
        .color-btn { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; }
        .color-btn.active { border-color: white; }
        
        .chat-input-area { padding: 10px 14px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .quick-btns { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .quick-btn { padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; font-size: 0.65em; cursor: pointer; color: var(--text2); }
        .quick-btn:hover { border-color: var(--purple); color: var(--text); }
        .chat-input-row { display: flex; gap: 6px; }
        .chat-input { flex: 1; padding: 8px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8em; resize: none; }
        .chat-input:focus { outline: none; border-color: var(--purple); }
        .chat-send { padding: 8px 14px; background: var(--purple); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75em; }
        .chat-send:disabled { opacity: 0.5; }
        
        .footer-btn { padding: 8px 14px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .footer-btn button { width: 100%; padding: 6px; font-size: 0.75em; }
        
        .empty { text-align: center; padding: 30px; color: var(--text2); font-size: 0.85em; }
        
        /* Modal */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg2); border-radius: 10px; padding: 20px; width: 90%; max-width: 450px; }
        .modal h2 { font-size: 1em; margin-bottom: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75em; color: var(--text2); margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.85em; }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        .modal-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .btn { padding: 8px 16px; border-radius: 4px; font-size: 0.8em; cursor: pointer; border: none; }
        .btn-primary { background: var(--purple); color: white; }
        .btn-secondary { background: var(--bg3); color: var(--text); }
    </style>
</head>
<body>
<div class="app" id="app">
    <!-- Papers Panel -->
    <div class="panel papers-panel" id="papers-panel">
        <div class="panel-header">
            <h1>üî¨ AI Papers Daily</h1>
        </div>
        <div class="search-sort">
            <input type="text" class="search-box" id="search" placeholder="Search..." oninput="filterPapers()">
            <div class="sort-row">
                <select class="sort-select" id="sort-select" onchange="filterPapers()">
                    <option value="score-desc">‚≠ê Highest Rated</option>
                    <option value="score-asc">‚≠ê Lowest Rated</option>
                    <option value="date-desc">üìÖ Newest First</option>
                    <option value="date-asc">üìÖ Oldest First</option>
                </select>
            </div>
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="papers-list" id="papers-list"><div class="empty">Loading...</div></div>
        <div class="footer-btn">
            <button class="paper-btn" onclick="openAddModal()">‚ûï Add Paper</button>
        </div>
    </div>
    
    <div class="resizer" id="resizer1"></div>
    
    <!-- PDF Panel -->
    <div class="panel pdf-panel" id="pdf-panel">
        <div class="pdf-header">
            <div class="pdf-title" id="pdf-title"></div>
            <div class="pdf-actions">
                <a href="#" id="pdf-newtab" target="_blank">New tab ‚Üó</a>
                <a href="#" id="pdf-page" target="_blank">Paper ‚Üó</a>
                <button class="close-btn" id="close-pdf-btn">‚úï Close</button>
            </div>
        </div>
        <iframe class="pdf-frame" id="pdf-frame"></iframe>
    </div>
    
    <div class="resizer" id="resizer2"></div>
    
    <!-- Chat Panel -->
    <div class="panel chat-panel" id="chat-panel">
        <div class="panel-header">
            <h2><div class="ai-status"></div> Ask AI</h2>
        </div>
        <div class="chat-context" id="chat-context">Select a paper to start</div>
        <div class="chat-body">
            <div class="chat-messages" id="chat-messages">
                <div class="msg ai">
                    <div class="msg-avatar">ü§ñ</div>
                    <div class="msg-content">Hi! Click a paper and open its PDF. I'll help you understand it.</div>
                </div>
            </div>
            
            <!-- Whiteboard -->
            <div class="whiteboard-section">
                <div class="whiteboard-header" onclick="toggleWhiteboard()">
                    <h3>üìù Whiteboard</h3>
                    <span id="wb-toggle">‚ñ≤</span>
                </div>
                <div class="whiteboard-content" id="wb-content">
                    <div class="whiteboard-tabs">
                        <div class="wb-tab active" onclick="switchWbTab('draw')">üé® Draw</div>
                        <div class="wb-tab" onclick="switchWbTab('notes')">üìù Notes</div>
                    </div>
                    <div class="wb-panel active" id="wb-draw">
                        <div class="wb-tools">
                            <button class="wb-tool active" onclick="setTool('pen')">‚úèÔ∏è Pen</button>
                            <button class="wb-tool" onclick="setTool('eraser')">üßπ Eraser</button>
                            <button class="wb-tool" onclick="clearCanvas()">üóëÔ∏è Clear</button>
                            <span style="border-left:1px solid var(--border);margin:0 4px"></span>
                            <button class="color-btn active" style="background:#fff" onclick="setColor('#fff')"></button>
                            <button class="color-btn" style="background:#58a6ff" onclick="setColor('#58a6ff')"></button>
                            <button class="color-btn" style="background:#f0883e" onclick="setColor('#f0883e')"></button>
                            <button class="color-btn" style="background:#238636" onclick="setColor('#238636')"></button>
                            <button class="color-btn" style="background:#da3633" onclick="setColor('#da3633')"></button>
                        </div>
                        <canvas class="whiteboard-canvas" id="canvas"></canvas>
                    </div>
                    <div class="wb-panel" id="wb-notes">
                        <textarea class="whiteboard-textarea" id="notes" placeholder="Your notes, equations, code..."></textarea>
                    </div>
                    <div class="wb-tools">
                        <button class="wb-tool" onclick="askAboutWhiteboard()">ü§ñ Ask AI about this</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="quick-btns">
                <span class="quick-btn" onclick="askAI('Summarize this paper')">Summarize</span>
                <span class="quick-btn" onclick="askAI('Key contribution?')">Key point</span>
                <span class="quick-btn" onclick="askAI('Explain the method')">Method</span>
                <span class="quick-btn" onclick="askAI('Results?')">Results</span>
            </div>
            <div class="chat-input-row">
                <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask about this paper..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                <button class="chat-send" id="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Paper Modal -->
<div class="modal-bg" id="add-modal" onclick="if(event.target===this)closeAddModal()">
    <div class="modal">
        <h2>‚ûï Add Paper</h2>
        <form onsubmit="saveCustomPaper(event)">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="add-title" required placeholder="Attention Is All You Need">
            </div>
            <div class="form-group">
                <label>URL *</label>
                <input type="url" id="add-url" required placeholder="https://arxiv.org/abs/...">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Authors</label>
                    <input type="text" id="add-authors" placeholder="Vaswani et al.">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="add-date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Score (1-10)</label>
                    <input type="number" id="add-score" min="1" max="10" placeholder="8">
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" id="add-tags" placeholder="transformers, nlp">
                </div>
            </div>
            <div class="modal-btns">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </form>
    </div>
</div>

<script>
// ============ STATE ============
let allPapers = [];
let customPapers = JSON.parse(localStorage.getItem('customPapers') || '[]');
let savedPapers = JSON.parse(localStorage.getItem('savedPapers') || '[]');
let currentTab = 'today';
let selectedPaper = null;
let chatHistory = [];
let isTyping = false;

// Whiteboard state
let canvas, ctx;
let drawing = false;
let tool = 'pen';
let penColor = '#fff';
let lastX = 0, lastY = 0;

// ============ INIT ============
document.addEventListener('DOMContentLoaded', () => {
    initResizers();
    initCanvas();
    initClosePdf();
    loadNotes();
    loadData();
});

function initClosePdf() {
    document.getElementById('close-pdf-btn').addEventListener('click', closePDF);
}

function closePDF() {
    document.getElementById('pdf-panel').classList.remove('open');
    document.getElementById('pdf-frame').src = '';
}

// ============ RESIZABLE PANELS ============
function initResizers() {
    const resizer1 = document.getElementById('resizer1');
    const resizer2 = document.getElementById('resizer2');
    const papersPanel = document.getElementById('papers-panel');
    const chatPanel = document.getElementById('chat-panel');
    
    let isResizing = false;
    let currentResizer = null;
    
    function startResize(e, resizer) {
        isResizing = true;
        currentResizer = resizer;
        resizer.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    }
    
    resizer1.addEventListener('mousedown', (e) => startResize(e, resizer1));
    resizer2.addEventListener('mousedown', (e) => startResize(e, resizer2));
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        if (currentResizer === resizer1) {
            const newWidth = e.clientX;
            if (newWidth >= 200 && newWidth <= 600) {
                papersPanel.style.width = newWidth + 'px';
            }
        } else if (currentResizer === resizer2) {
            const newWidth = window.innerWidth - e.clientX;
            if (newWidth >= 250 && newWidth <= 700) {
                chatPanel.style.width = newWidth + 'px';
            }
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            currentResizer?.classList.remove('dragging');
            currentResizer = null;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

// ============ CANVAS WHITEBOARD ============
function initCanvas() {
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');
    
    // Set canvas size
    function resizeCanvas() {
        const rect = canvas.parentElement.getBoundingClientRect();
        canvas.width = rect.width || 400;
        canvas.height = 180;
        // Restore saved drawing
        const saved = localStorage.getItem('canvasData');
        if (saved) {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = saved;
        }
    }
    resizeCanvas();
    
    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = tool === 'eraser' ? '#1a1a2e' : penColor;
        ctx.lineWidth = tool === 'eraser' ? 20 : 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    
    canvas.addEventListener('mouseup', saveCanvas);
    canvas.addEventListener('mouseleave', () => { drawing = false; saveCanvas(); });
    
    // Touch support
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        drawing = true;
        [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
    });
    
    canvas.addEventListener('touchmove', (e) => {
        if (!drawing) return;
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = tool === 'eraser' ? '#1a1a2e' : penColor;
        ctx.lineWidth = tool === 'eraser' ? 20 : 2;
        ctx.lineCap = 'round';
        ctx.stroke();
        [lastX, lastY] = [x, y];
    });
    
    canvas.addEventListener('touchend', saveCanvas);
}

function saveCanvas() {
    drawing = false;
    localStorage.setItem('canvasData', canvas.toDataURL());
}

function setTool(t) {
    tool = t;
    document.querySelectorAll('.wb-tool').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
}

function setColor(c) {
    penColor = c;
    tool = 'pen';
    document.querySelectorAll('.color-btn').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    localStorage.removeItem('canvasData');
}

function toggleWhiteboard() {
    const content = document.getElementById('wb-content');
    const toggle = document.getElementById('wb-toggle');
    content.classList.toggle('show');
    toggle.textContent = content.classList.contains('show') ? '‚ñº' : '‚ñ≤';
}

function switchWbTab(tab) {
    document.querySelectorAll('.wb-tab').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.wb-panel').forEach(el => el.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('wb-' + tab).classList.add('active');
}

function loadNotes() {
    document.getElementById('notes').value = localStorage.getItem('notes') || '';
    document.getElementById('notes').addEventListener('input', (e) => {
        localStorage.setItem('notes', e.target.value);
    });
}

function askAboutWhiteboard() {
    const notes = document.getElementById('notes').value.trim();
    if (notes) {
        askAI('Help me with these notes:\n\n' + notes);
    } else {
        addMessage('ai', 'Write some notes first, then I can help explain or expand on them!');
    }
}

// ============ DATA ============
async function loadData() {
    try {
        const res = await fetch('papers.json');
        const data = await res.json();
        allPapers = data.papers || [];
        renderTabs();
        filterPapers();
    } catch (e) {
        document.getElementById('papers-list').innerHTML = '<div class="empty">No papers loaded</div>';
        renderTabs();
    }
}

// ============ DATE HELPERS ============
function getToday() {
    return new Date().toISOString().split('T')[0];
}

function parseDate(dateStr) {
    if (!dateStr) return null;
    // Handle both "Dec 31" and "2024-12-31" formats
    if (dateStr.includes('-')) return dateStr.split('T')[0];
    try {
        const d = new Date(dateStr + ' ' + new Date().getFullYear());
        return d.toISOString().split('T')[0];
    } catch { return null; }
}

function isToday(paper) {
    const paperDate = parseDate(paper.pubDateISO || paper.pubDate);
    return paperDate === getToday();
}

function formatDate(dateStr) {
    if (!dateStr) return '?';
    try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } catch { return dateStr; }
}

// ============ TABS ============
function renderTabs() {
    const todayPapers = allPapers.filter(isToday);
    const counts = {
        today: todayPapers.length,
        all: allPapers.length,
        top: allPapers.filter(p => p.score >= 8).length,
        saved: savedPapers.length,
        mine: customPapers.length
    };
    
    // If no papers today, show all
    if (counts.today === 0 && currentTab === 'today') {
        currentTab = 'all';
    }
    
    const tabs = [
        { id: 'today', label: 'Today', count: counts.today },
        { id: 'all', label: 'All', count: counts.all },
        { id: 'top', label: 'üî• Top', count: counts.top },
        { id: 'saved', label: 'üìö', count: counts.saved },
        { id: 'mine', label: 'üìÅ', count: counts.mine }
    ];
    
    document.getElementById('tabs').innerHTML = tabs.map(t => 
        `<div class="tab ${currentTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}<span class="count">${t.count}</span></div>`
    ).join('');
}

function switchTab(tab) {
    currentTab = tab;
    renderTabs();
    filterPapers();
}

// ============ FILTER & SORT ============
function filterPapers() {
    const query = document.getElementById('search').value.toLowerCase();
    const sort = document.getElementById('sort-select').value;
    let papers = [];
    
    // Filter by tab
    if (currentTab === 'today') {
        papers = allPapers.filter(isToday);
        if (papers.length === 0) papers = allPapers; // Fallback
    } else if (currentTab === 'all') {
        papers = allPapers;
    } else if (currentTab === 'top') {
        papers = allPapers.filter(p => p.score >= 8);
    } else if (currentTab === 'saved') {
        papers = [...customPapers, ...allPapers].filter(p => savedPapers.includes(p.id));
    } else if (currentTab === 'mine') {
        papers = customPapers;
    }
    
    // Search filter
    if (query) {
        papers = papers.filter(p => 
            p.title?.toLowerCase().includes(query) || 
            p.authors?.toLowerCase().includes(query)
        );
    }
    
    // Sort
    papers = [...papers].sort((a, b) => {
        const dateA = parseDate(a.pubDateISO || a.pubDate) || '1970-01-01';
        const dateB = parseDate(b.pubDateISO || b.pubDate) || '1970-01-01';
        
        switch (sort) {
            case 'score-desc': return (b.score || 0) - (a.score || 0);
            case 'score-asc': return (a.score || 0) - (b.score || 0);
            case 'date-desc': return dateB.localeCompare(dateA);
            case 'date-asc': return dateA.localeCompare(dateB);
            default: return 0;
        }
    });
    
    renderPapers(papers);
}

function renderPapers(papers) {
    const container = document.getElementById('papers-list');
    
    if (!papers.length) {
        container.innerHTML = '<div class="empty">No papers found</div>';
        return;
    }
    
    container.innerHTML = papers.map(p => {
        const scoreClass = p.score >= 8 ? 'high' : p.score >= 6 ? 'medium' : 'low';
        const isSaved = savedPapers.includes(p.id);
        const isSelected = selectedPaper?.id === p.id;
        const pdfUrl = getPdfUrl(p);
        const dateStr = formatDate(p.pubDateISO || p.pubDate);
        
        return `<div class="paper ${isSelected ? 'selected' : ''}" onclick="selectPaper('${p.id}')">
            <div class="paper-title">${p.title}</div>
            <div class="paper-meta">
                <span class="paper-date">üìÖ ${dateStr}</span>
                <span>${(p.authors || 'Unknown').substring(0, 40)}</span>
                <span class="paper-score ${scoreClass}">${p.score || '?'}/10</span>
            </div>
            <div class="paper-actions">
                ${pdfUrl ? `<button class="paper-btn primary" onclick="event.stopPropagation();openPDF('${p.id}')">üìÑ PDF</button>` : ''}
                <button class="paper-btn ${isSaved ? 'saved' : ''}" onclick="event.stopPropagation();toggleSave('${p.id}')">${isSaved ? '‚úì' : 'Save'}</button>
                <a href="${p.link}" target="_blank" class="paper-btn" onclick="event.stopPropagation()">‚Üó</a>
                ${p.isCustom ? `<button class="paper-btn" onclick="event.stopPropagation();deleteCustom('${p.id}')" style="color:var(--red)">üóë</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

function getPdfUrl(p) {
    if (p.pdf_link) return p.pdf_link;
    if (p.link?.includes('arxiv.org/abs/')) return p.link.replace('/abs/', '/pdf/') + '.pdf';
    return null;
}

// ============ PAPER ACTIONS ============
function selectPaper(id) {
    selectedPaper = [...customPapers, ...allPapers].find(p => p.id === id);
    if (selectedPaper) {
        document.getElementById('chat-context').innerHTML = `üìÑ <strong>${selectedPaper.title}</strong>`;
    }
    filterPapers();
}

function openPDF(id) {
    selectPaper(id);
    if (!selectedPaper) return;
    
    const pdfUrl = getPdfUrl(selectedPaper);
    if (!pdfUrl) return alert('No PDF available');
    
    document.getElementById('pdf-panel').classList.add('open');
    document.getElementById('pdf-title').textContent = selectedPaper.title;
    document.getElementById('pdf-newtab').href = pdfUrl;
    document.getElementById('pdf-page').href = selectedPaper.link;
    document.getElementById('pdf-frame').src = pdfUrl;
    
    addMessage('ai', `Opened "<strong>${selectedPaper.title}</strong>". What would you like to know?`);
}

function toggleSave(id) {
    if (savedPapers.includes(id)) savedPapers = savedPapers.filter(x => x !== id);
    else savedPapers.push(id);
    localStorage.setItem('savedPapers', JSON.stringify(savedPapers));
    renderTabs();
    filterPapers();
}

function deleteCustom(id) {
    if (!confirm('Delete?')) return;
    customPapers = customPapers.filter(p => p.id !== id);
    localStorage.setItem('customPapers', JSON.stringify(customPapers));
    renderTabs();
    filterPapers();
}

// ============ ADD PAPER ============
function openAddModal() { document.getElementById('add-modal').classList.add('show'); }
function closeAddModal() { document.getElementById('add-modal').classList.remove('show'); }

function saveCustomPaper(e) {
    e.preventDefault();
    const url = document.getElementById('add-url').value;
    customPapers.unshift({
        id: 'custom-' + Date.now(),
        title: document.getElementById('add-title').value,
        link: url,
        pdf_link: url.includes('arxiv.org/abs/') ? url.replace('/abs/', '/pdf/') + '.pdf' : null,
        authors: document.getElementById('add-authors').value || 'Unknown',
        pubDateISO: document.getElementById('add-date').value || getToday(),
        score: parseInt(document.getElementById('add-score').value) || 7,
        tags: document.getElementById('add-tags').value.split(',').map(t => t.trim()).filter(Boolean),
        isCustom: true
    });
    localStorage.setItem('customPapers', JSON.stringify(customPapers));
    closeAddModal();
    document.querySelector('#add-modal form').reset();
    switchTab('mine');
}

// ============ AI CHAT ============
function askAI(text) {
    document.getElementById('chat-input').value = text;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg || isTyping) return;
    
    if (!selectedPaper) {
        addMessage('ai', 'Please select a paper first by clicking on it.');
        return;
    }
    
    addMessage('user', msg);
    input.value = '';
    chatHistory.push({ role: 'user', content: msg });
    
    isTyping = true;
    document.getElementById('send-btn').disabled = true;
    const typingEl = showTyping();
    
    try {
        // Call YOUR backend API (you'll deploy this)
        const response = await fetch('https://empty-bonus-8168.arps000000.workers.dev/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: msg,
                paper: {
                    title: selectedPaper.title,
                    authors: selectedPaper.authors,
                    abstract: selectedPaper.abstract,
                    tags: selectedPaper.tags
                },
                history: chatHistory.slice(-8)
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            typingEl.remove();
            addMessage('ai', data.response);
            chatHistory.push({ role: 'assistant', content: data.response });
        } else {
            throw new Error('API error');
        }
    } catch (e) {
        // Fallback for static hosting (no backend)
        typingEl.remove();
        const fallback = getFallback(msg);
        addMessage('ai', fallback);
        chatHistory.push({ role: 'assistant', content: fallback });
    }
    
    isTyping = false;
    document.getElementById('send-btn').disabled = false;
}

function getFallback(msg) {
    const p = selectedPaper;
    const m = msg.toLowerCase();
    
    if (m.includes('summar')) {
        return `<strong>${p.title}</strong><br><br>${p.abstract?.slice(0, 400) || p.key_contribution || 'Open the PDF to read the full paper.'}<br><br>Score: ${p.score}/10`;
    }
    if (m.includes('key') || m.includes('contribution')) {
        return p.key_contribution || `This paper focuses on ${p.tags?.join(', ') || 'AI research'}. Check the abstract in the PDF.`;
    }
    if (m.includes('method')) {
        return `The methodology is typically in Sections 3-4 of the PDF. Based on tags: ${p.tags?.join(', ') || 'not specified'}.`;
    }
    
    return `I'm in offline mode (no backend). For live AI, deploy the API endpoint.<br><br>Meanwhile, here's what I know about "<strong>${p.title}</strong>":<br>${p.abstract?.slice(0, 200) || 'Open the PDF for details.'}...`;
}

function addMessage(role, content) {
    const container = document.getElementById('chat-messages');
    container.innerHTML += `<div class="msg ${role}">
        <div class="msg-avatar">${role === 'ai' ? 'ü§ñ' : 'üë§'}</div>
        <div class="msg-content">${content}</div>
    </div>`;
    container.scrollTop = container.scrollHeight;
}

function showTyping() {
    const container = document.getElementById('chat-messages');
    const el = document.createElement('div');
    el.className = 'msg ai';
    el.innerHTML = `<div class="msg-avatar">ü§ñ</div><div class="msg-content typing"><span></span><span></span><span></span></div>`;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
    return el;
}
</script>
</body>
</html>
