<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Papers Daily</title>
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --border: #30363d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #238636;
            --orange: #f0883e;
            --red: #da3633;
            --purple: #a371f7;
            --yellow: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; overflow: hidden; }
        
        .app { display: flex; flex-direction: column; height: 100vh; }
        
        /* Toolbar */
        .toolbar { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 100; }
        .toolbar h1 { font-size: 1em; }
        .toolbar-right { display: flex; gap: 8px; align-items: center; }
        .tool-btn { padding: 6px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text2); font-size: 0.75em; cursor: pointer; }
        .tool-btn:hover { background: var(--border); color: var(--text); }
        
        /* Workspace - the dock container */
        .workspace { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Dock areas */
        .dock-area { display: flex; flex: 1; overflow: hidden; }
        .dock-area.horizontal { flex-direction: row; }
        .dock-area.vertical { flex-direction: column; }
        
        /* Resizer */
        .resizer { background: var(--border); flex-shrink: 0; z-index: 10; transition: background 0.15s; }
        .resizer:hover, .resizer.active { background: var(--blue); }
        .resizer.horizontal { width: 4px; cursor: col-resize; }
        .resizer.vertical { height: 4px; cursor: row-resize; }
        
        /* Panel container - holds tabs + content */
        .panel-container { display: flex; flex-direction: column; overflow: hidden; background: var(--bg); min-width: 200px; min-height: 150px; position: relative; }
        
        /* Tab bar */
        .tab-bar { display: flex; align-items: center; background: var(--bg2); border-bottom: 1px solid var(--border); min-height: 36px; flex-shrink: 0; overflow-x: auto; }
        .tab-bar::-webkit-scrollbar { height: 0; }
        
        .tab { display: flex; align-items: center; gap: 6px; padding: 8px 14px; font-size: 0.8em; color: var(--text2); cursor: grab; border-right: 1px solid var(--border); white-space: nowrap; user-select: none; transition: background 0.1s; }
        .tab:hover { background: var(--bg3); color: var(--text); }
        .tab.active { background: var(--bg); color: var(--text); border-bottom: 2px solid var(--blue); margin-bottom: -1px; }
        .tab.dragging { opacity: 0.5; }
        .tab .close-tab { margin-left: 6px; opacity: 0.5; font-size: 0.8em; }
        .tab .close-tab:hover { opacity: 1; color: var(--red); }
        
        .tab-bar-actions { margin-left: auto; display: flex; padding: 0 8px; gap: 4px; }
        .tab-bar-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; border-radius: 4px; color: var(--text2); cursor: pointer; font-size: 0.8em; }
        .tab-bar-btn:hover { background: var(--bg3); color: var(--text); }
        
        /* Panel content */
        .panel-content { flex: 1; overflow: hidden; display: none; flex-direction: column; }
        .panel-content.active { display: flex; }
        
        /* Drop zones */
        .drop-zone { position: absolute; background: rgba(88, 166, 255, 0.15); border: 2px dashed var(--blue); z-index: 100; display: none; pointer-events: none; }
        .drop-zone.visible { display: block; }
        .drop-zone.center { inset: 20%; }
        .drop-zone.top { top: 0; left: 0; right: 0; height: 40%; }
        .drop-zone.bottom { bottom: 0; left: 0; right: 0; height: 40%; }
        .drop-zone.left { top: 0; bottom: 0; left: 0; width: 40%; }
        .drop-zone.right { top: 0; bottom: 0; right: 0; width: 40%; }
        .drop-zone.tab-bar { top: 0; left: 0; right: 0; height: 36px; background: rgba(88, 166, 255, 0.3); }
        
        /* Floating drag preview */
        .drag-preview { position: fixed; background: var(--bg2); border: 1px solid var(--blue); border-radius: 6px; padding: 8px 14px; font-size: 0.8em; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        
        /* Content styles */
        .search-area { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        .search-box { width: 100%; padding: 8px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85em; margin-bottom: 8px; }
        .search-box:focus { outline: none; border-color: var(--blue); }
        .filter-select { width: 100%; padding: 6px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.75em; cursor: pointer; }
        
        .tabs-row { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); overflow-x: auto; flex-shrink: 0; }
        .filter-tab { padding: 8px 14px; font-size: 0.75em; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .filter-tab:hover { color: var(--text); }
        .filter-tab.active { color: var(--blue); border-bottom-color: var(--blue); }
        .filter-tab .count { background: var(--bg3); padding: 2px 6px; border-radius: 10px; font-size: 0.7em; margin-left: 4px; }
        .filter-tab.active .count { background: var(--blue); color: white; }
        
        .papers-list { flex: 1; overflow-y: auto; }
        .paper { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .paper:hover { background: var(--bg2); }
        .paper.selected { background: rgba(88,166,255,0.1); border-left: 3px solid var(--blue); padding-left: 9px; }
        .paper-title { font-size: 0.85em; font-weight: 600; margin-bottom: 6px; line-height: 1.4; }
        .paper-meta { font-size: 0.72em; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 6px; }
        .paper-date { color: var(--orange); }
        .paper-score { padding: 2px 6px; border-radius: 4px; font-size: 0.65em; font-weight: 600; }
        .paper-score.high { background: var(--green); color: white; }
        .paper-score.medium { background: var(--blue); color: white; }
        .paper-score.low { background: var(--bg3); color: var(--text2); }
        .paper-actions { display: flex; gap: 6px; margin-top: 8px; }
        .paper-btn { padding: 4px 10px; font-size: 0.7em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text2); cursor: pointer; text-decoration: none; }
        .paper-btn:hover { background: var(--border); color: var(--text); }
        .paper-btn.primary { background: var(--blue); border-color: var(--blue); color: white; }
        .paper-btn.saved { background: var(--green); border-color: var(--green); color: white; }
        .add-paper-btn { margin: 12px; padding: 8px; width: calc(100% - 24px); }
        
        .pdf-toolbar { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); flex-shrink: 0; }
        .pdf-title { font-size: 0.8em; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 12px; }
        .pdf-links { display: flex; gap: 12px; align-items: center; }
        .pdf-links a { font-size: 0.75em; color: var(--blue); text-decoration: none; }
        .pdf-frame { flex: 1; border: none; background: #2d2d2d; }
        .pdf-placeholder { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text2); gap: 12px; }
        .pdf-placeholder-icon { font-size: 4em; opacity: 0.2; }
        
        .chat-context { padding: 8px 12px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.75em; color: var(--text2); flex-shrink: 0; }
        .chat-context strong { color: var(--purple); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; }
        .msg { margin-bottom: 12px; display: flex; gap: 10px; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7em; flex-shrink: 0; }
        .msg.user .msg-avatar { background: var(--blue); }
        .msg.ai .msg-avatar { background: var(--purple); }
        .msg-content { padding: 10px 14px; border-radius: 12px; font-size: 0.85em; line-height: 1.6; max-width: 85%; }
        .msg.user .msg-content { background: var(--blue); margin-left: auto; }
        .msg.ai .msg-content { background: var(--bg3); }
        .typing span { width: 6px; height: 6px; background: var(--text2); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite; margin-right: 4px; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); background: var(--bg); flex-shrink: 0; }
        .quick-btns { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .quick-btn { padding: 5px 10px; background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; font-size: 0.72em; cursor: pointer; color: var(--text2); }
        .quick-btn:hover { border-color: var(--purple); color: var(--text); }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.85em; resize: none; }
        .chat-input:focus { outline: none; border-color: var(--purple); }
        .chat-send { padding: 10px 18px; background: var(--purple); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.8em; font-weight: 500; }
        .chat-send:disabled { opacity: 0.5; }
        
        .wb-toolbar { padding: 8px 12px; display: flex; gap: 8px; flex-wrap: wrap; border-bottom: 1px solid var(--border); background: var(--bg); flex-shrink: 0; }
        .wb-tool { padding: 6px 10px; font-size: 0.75em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text2); }
        .wb-tool:hover { background: var(--border); }
        .wb-tool.active { background: var(--yellow); color: black; border-color: var(--yellow); }
        .color-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; }
        .color-btn.active { border-color: white; }
        .wb-canvas-container { flex: 1; position: relative; overflow: hidden; }
        .whiteboard-canvas { width: 100%; height: 100%; background: #1a1a2e; cursor: crosshair; display: block; }
        .whiteboard-textarea { width: 100%; height: 100%; background: var(--bg2); border: none; color: var(--text); font-family: Monaco, monospace; font-size: 0.85em; padding: 12px; resize: none; }
        .whiteboard-textarea:focus { outline: none; }
        
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 1000; align-items: center; justify-content: center; }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg2); border-radius: 12px; padding: 24px; width: 90%; max-width: 450px; border: 1px solid var(--border); }
        .modal h2 { font-size: 1.1em; margin-bottom: 20px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.8em; color: var(--text2); margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 10px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9em; }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }
        .modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-size: 0.85em; cursor: pointer; border: none; font-weight: 500; }
        .btn-primary { background: var(--purple); color: white; }
        .btn-secondary { background: var(--bg3); color: var(--text); }
        
        .empty { text-align: center; padding: 40px; color: var(--text2); font-size: 0.9em; }
        .ai-status { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; }
        
        /* Help tooltip */
        .help-tip { position: fixed; bottom: 20px; right: 20px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; font-size: 0.75em; color: var(--text2); z-index: 50; max-width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .help-tip strong { color: var(--blue); }
        .help-tip-close { position: absolute; top: 8px; right: 8px; background: none; border: none; color: var(--text2); cursor: pointer; }
    </style>
</head>
<body>
<div class="app">
    <div class="toolbar">
        <h1>üî¨ AI Papers Daily</h1>
        <div class="toolbar-right">
            <button class="tool-btn" onclick="resetLayout()">‚Ü∫ Reset Layout</button>
            <button class="tool-btn" onclick="toggleHelp()">? Help</button>
        </div>
    </div>
    
    <div class="workspace" id="workspace"></div>
</div>

<div class="help-tip" id="help-tip" style="display:none;">
    <button class="help-tip-close" onclick="toggleHelp()">‚úï</button>
    <strong>Drag & Drop Panels</strong><br><br>
    ‚Ä¢ Drag any tab to rearrange<br>
    ‚Ä¢ Drop on edges to split<br>
    ‚Ä¢ Drop on tab bar to merge<br>
    ‚Ä¢ Drag borders to resize
</div>

<div class="modal-bg" id="add-modal" onclick="if(event.target===this)closeAddModal()">
    <div class="modal">
        <h2>‚ûï Add Paper</h2>
        <form onsubmit="saveCustomPaper(event)">
            <div class="form-group"><label>Title *</label><input type="text" id="add-title" required placeholder="Attention Is All You Need"></div>
            <div class="form-group"><label>URL *</label><input type="url" id="add-url" required placeholder="https://arxiv.org/abs/..."></div>
            <div class="form-row">
                <div class="form-group"><label>Authors</label><input type="text" id="add-authors" placeholder="Vaswani et al."></div>
                <div class="form-group"><label>Date</label><input type="date" id="add-date"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Score (1-10)</label><input type="number" id="add-score" min="1" max="10" placeholder="8"></div>
                <div class="form-group"><label>Tags</label><input type="text" id="add-tags" placeholder="transformers, nlp"></div>
            </div>
            <div class="modal-btns">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Paper</button>
            </div>
        </form>
    </div>
</div>

<script>
// ============ PANEL DEFINITIONS ============
const PANELS = {
    papers: { id: 'papers', title: 'üìö Papers', icon: 'üìö' },
    pdf: { id: 'pdf', title: 'üìÑ PDF Viewer', icon: 'üìÑ' },
    chat: { id: 'chat', title: 'üí¨ Ask AI', icon: 'üí¨' },
    whiteboard: { id: 'whiteboard', title: 'üé® Whiteboard', icon: 'üé®' },
    notes: { id: 'notes', title: 'üìù Notes', icon: 'üìù' }
};

// ============ STATE ============
let allPapers = [], customPapers = JSON.parse(localStorage.getItem('customPapers') || '[]'), savedPapers = JSON.parse(localStorage.getItem('savedPapers') || '[]');
let currentTab = 'all', selectedPaper = null, chatHistory = [], isTyping = false;
let canvas, ctx, drawing = false, tool = 'pen', penColor = '#fff', lastX = 0, lastY = 0;

// Layout state
let layoutState = null;
let dragState = null;

// ============ DEFAULT LAYOUT ============
const DEFAULT_LAYOUT = {
    type: 'horizontal',
    children: [
        { type: 'panel', tabs: ['papers'], activeTab: 'papers', size: 340 },
        { type: 'vertical', size: null, children: [
            { type: 'panel', tabs: ['pdf'], activeTab: 'pdf', size: null },
            { type: 'panel', tabs: ['whiteboard', 'notes'], activeTab: 'whiteboard', size: 280 }
        ]},
        { type: 'panel', tabs: ['chat'], activeTab: 'chat', size: 380 }
    ]
};

// ============ INIT ============
document.addEventListener('DOMContentLoaded', () => {
    loadLayout();
    renderLayout();
    loadData();
    initDragDrop();
});

// ============ LAYOUT MANAGEMENT ============
function loadLayout() {
    const saved = localStorage.getItem('dockLayout');
    if (saved) {
        try { layoutState = JSON.parse(saved); } 
        catch(e) { layoutState = JSON.parse(JSON.stringify(DEFAULT_LAYOUT)); }
    } else {
        layoutState = JSON.parse(JSON.stringify(DEFAULT_LAYOUT));
    }
}

function saveLayout() {
    localStorage.setItem('dockLayout', JSON.stringify(layoutState));
}

function resetLayout() {
    layoutState = JSON.parse(JSON.stringify(DEFAULT_LAYOUT));
    saveLayout();
    renderLayout();
}

// ============ RENDER LAYOUT ============
function renderLayout() {
    const workspace = document.getElementById('workspace');
    workspace.innerHTML = '';
    workspace.appendChild(renderNode(layoutState));
    
    // Initialize panel contents
    initPanelContents();
    initResizers();
}

function renderNode(node, parent = null) {
    if (node.type === 'horizontal' || node.type === 'vertical') {
        const container = document.createElement('div');
        container.className = `dock-area ${node.type}`;
        container.dataset.nodeId = Math.random().toString(36).substr(2, 9);
        
        node.children.forEach((child, i) => {
            if (i > 0) {
                const resizer = document.createElement('div');
                resizer.className = `resizer ${node.type === 'horizontal' ? 'horizontal' : 'vertical'}`;
                resizer.dataset.index = i;
                container.appendChild(resizer);
            }
            const childEl = renderNode(child, node);
            if (child.size) {
                if (node.type === 'horizontal') childEl.style.width = child.size + 'px';
                else childEl.style.height = child.size + 'px';
                childEl.style.flex = 'none';
            } else {
                childEl.style.flex = '1';
            }
            container.appendChild(childEl);
        });
        
        return container;
    } else if (node.type === 'panel') {
        return renderPanelContainer(node);
    }
}

function renderPanelContainer(node) {
    const container = document.createElement('div');
    container.className = 'panel-container';
    container.dataset.nodeId = Math.random().toString(36).substr(2, 9);
    
    // Tab bar
    const tabBar = document.createElement('div');
    tabBar.className = 'tab-bar';
    
    node.tabs.forEach(tabId => {
        const panel = PANELS[tabId];
        if (!panel) return;
        
        const tab = document.createElement('div');
        tab.className = `tab ${node.activeTab === tabId ? 'active' : ''}`;
        tab.dataset.panelId = tabId;
        tab.draggable = true;
        tab.innerHTML = `<span>${panel.icon}</span> ${panel.title.replace(panel.icon + ' ', '')}`;
        tab.onclick = () => activateTab(container, tabId);
        tabBar.appendChild(tab);
    });
    
    // Tab bar actions
    const actions = document.createElement('div');
    actions.className = 'tab-bar-actions';
    actions.innerHTML = `<button class="tab-bar-btn" onclick="maximizePanel(this)" title="Maximize">‚§¢</button>`;
    tabBar.appendChild(actions);
    
    container.appendChild(tabBar);
    
    // Panel contents
    node.tabs.forEach(tabId => {
        const content = document.createElement('div');
        content.className = `panel-content ${node.activeTab === tabId ? 'active' : ''}`;
        content.dataset.panelId = tabId;
        content.innerHTML = getPanelContent(tabId);
        container.appendChild(content);
    });
    
    // Drop zones
    ['center', 'top', 'bottom', 'left', 'right', 'tab-bar'].forEach(zone => {
        const dropZone = document.createElement('div');
        dropZone.className = `drop-zone ${zone}`;
        dropZone.dataset.zone = zone;
        container.appendChild(dropZone);
    });
    
    return container;
}

function getPanelContent(panelId) {
    switch(panelId) {
        case 'papers': return `
            <div class="search-area">
                <input type="text" class="search-box" id="search" placeholder="Search papers..." oninput="filterPapers()">
                <select class="filter-select" id="sort-select" onchange="filterPapers()">
                    <option value="score-desc">‚≠ê Highest Rated</option>
                    <option value="score-asc">‚≠ê Lowest Rated</option>
                    <option value="date-desc">üìÖ Newest</option>
                    <option value="date-asc">üìÖ Oldest</option>
                </select>
            </div>
            <div class="tabs-row" id="tabs"></div>
            <div class="papers-list" id="papers-list"><div class="empty">Loading...</div></div>
            <button class="paper-btn add-paper-btn" onclick="openAddModal()">‚ûï Add Paper</button>`;
        case 'pdf': return `
            <div class="pdf-placeholder" id="pdf-placeholder"><div class="pdf-placeholder-icon">üìÑ</div><p>Select a paper and click "PDF"</p></div>
            <div class="pdf-toolbar" id="pdf-toolbar" style="display:none;">
                <div class="pdf-title" id="pdf-title"></div>
                <div class="pdf-links">
                    <a href="#" id="pdf-newtab" target="_blank">New Tab ‚Üó</a>
                    <a href="#" id="pdf-page" target="_blank">Paper ‚Üó</a>
                    <button class="paper-btn" onclick="closePDF()">‚úï</button>
                </div>
            </div>
            <iframe class="pdf-frame" id="pdf-frame" style="display:none;"></iframe>`;
        case 'chat': return `
            <div class="chat-context" id="chat-context">Select a paper to start</div>
            <div class="chat-messages" id="chat-messages">
                <div class="msg ai"><div class="msg-avatar">ü§ñ</div><div class="msg-content">Hi! Select a paper and open its PDF. I'll help you understand it.</div></div>
            </div>
            <div class="chat-input-area">
                <div class="quick-btns">
                    <span class="quick-btn" onclick="askAI('Summarize')">Summarize</span>
                    <span class="quick-btn" onclick="askAI('Key point?')">Key point</span>
                    <span class="quick-btn" onclick="askAI('Method?')">Method</span>
                    <span class="quick-btn" onclick="askAI('Results?')">Results</span>
                </div>
                <div class="chat-input-row">
                    <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask about this paper..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                    <button class="chat-send" id="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>`;
        case 'whiteboard': return `
            <div class="wb-toolbar">
                <button class="wb-tool active" onclick="setTool('pen',this)">‚úèÔ∏è Pen</button>
                <button class="wb-tool" onclick="setTool('eraser',this)">üßπ Eraser</button>
                <button class="wb-tool" onclick="clearCanvas()">üóëÔ∏è Clear</button>
                <span style="width:1px;background:var(--border);margin:0 4px"></span>
                <button class="color-btn active" style="background:#fff" onclick="setColor('#fff',this)"></button>
                <button class="color-btn" style="background:#58a6ff" onclick="setColor('#58a6ff',this)"></button>
                <button class="color-btn" style="background:#f0883e" onclick="setColor('#f0883e',this)"></button>
                <button class="color-btn" style="background:#238636" onclick="setColor('#238636',this)"></button>
                <button class="color-btn" style="background:#da3633" onclick="setColor('#da3633',this)"></button>
                <button class="wb-tool" style="margin-left:auto" onclick="askAboutCanvas()">ü§ñ Ask AI</button>
            </div>
            <div class="wb-canvas-container"><canvas class="whiteboard-canvas" id="canvas"></canvas></div>`;
        case 'notes': return `<textarea class="whiteboard-textarea" id="notes" placeholder="Your notes, equations, ideas..." style="flex:1"></textarea>`;
        default: return '<div class="empty">Unknown panel</div>';
    }
}

function initPanelContents() {
    // Papers
    renderTabs();
    filterPapers();
    
    // Canvas
    initCanvas();
    
    // Notes
    const notes = document.getElementById('notes');
    if (notes) {
        notes.value = localStorage.getItem('notes') || '';
        notes.oninput = () => localStorage.setItem('notes', notes.value);
    }
}

function activateTab(container, tabId) {
    container.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.panelId === tabId));
    container.querySelectorAll('.panel-content').forEach(c => c.classList.toggle('active', c.dataset.panelId === tabId));
    
    // Update layout state
    updateLayoutState();
    
    if (tabId === 'whiteboard') setTimeout(resizeCanvas, 50);
}

function updateLayoutState() {
    // Walk through DOM and update layoutState
    function walkNode(node, el) {
        if (node.type === 'panel') {
            const activeTab = el.querySelector('.tab.active');
            if (activeTab) node.activeTab = activeTab.dataset.panelId;
        } else if (node.children) {
            const children = el.querySelectorAll(':scope > .dock-area, :scope > .panel-container');
            node.children.forEach((child, i) => {
                if (children[i]) walkNode(child, children[i]);
            });
        }
    }
    walkNode(layoutState, document.getElementById('workspace').firstChild);
    saveLayout();
}

// ============ DRAG & DROP ============
function initDragDrop() {
    document.addEventListener('dragstart', handleDragStart);
    document.addEventListener('dragend', handleDragEnd);
    document.addEventListener('dragover', handleDragOver);
    document.addEventListener('drop', handleDrop);
}

function handleDragStart(e) {
    if (!e.target.classList.contains('tab')) return;
    
    const tabId = e.target.dataset.panelId;
    const container = e.target.closest('.panel-container');
    
    dragState = { tabId, sourceContainer: container };
    e.target.classList.add('dragging');
    
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', tabId);
    
    // Show drop zones
    setTimeout(() => {
        document.querySelectorAll('.panel-container').forEach(pc => {
            pc.querySelectorAll('.drop-zone').forEach(dz => dz.classList.add('visible'));
        });
    }, 0);
}

function handleDragEnd(e) {
    document.querySelectorAll('.tab.dragging').forEach(t => t.classList.remove('dragging'));
    document.querySelectorAll('.drop-zone').forEach(dz => dz.classList.remove('visible'));
    dragState = null;
}

function handleDragOver(e) {
    if (!dragState) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDrop(e) {
    if (!dragState) return;
    e.preventDefault();
    
    const dropZone = e.target.closest('.drop-zone');
    const targetContainer = e.target.closest('.panel-container');
    
    if (!targetContainer) return;
    
    const zone = dropZone?.dataset.zone || 'tab-bar';
    const { tabId, sourceContainer } = dragState;
    
    if (zone === 'tab-bar' || zone === 'center') {
        // Merge into existing panel
        mergeTabIntoPanel(tabId, sourceContainer, targetContainer);
    } else {
        // Split and create new panel
        splitPanel(tabId, sourceContainer, targetContainer, zone);
    }
    
    cleanupEmptyPanels();
    saveLayout();
    renderLayout();
}

function mergeTabIntoPanel(tabId, sourceContainer, targetContainer) {
    // Find nodes in layout
    function findPanelNode(node, container) {
        if (node.type === 'panel') {
            return node;
        }
        if (node.children) {
            for (let child of node.children) {
                const found = findPanelNode(child, container);
                if (found) return found;
            }
        }
        return null;
    }
    
    // Remove from source
    removeTabFromLayout(tabId);
    
    // Add to target (find target node)
    function addToTarget(node) {
        if (node.type === 'panel' && !node.tabs.includes(tabId)) {
            // Check if this is our target by comparing tabs
            const targetTabs = Array.from(targetContainer.querySelectorAll('.tab')).map(t => t.dataset.panelId);
            if (node.tabs.some(t => targetTabs.includes(t))) {
                node.tabs.push(tabId);
                node.activeTab = tabId;
                return true;
            }
        }
        if (node.children) {
            for (let child of node.children) {
                if (addToTarget(child)) return true;
            }
        }
        return false;
    }
    addToTarget(layoutState);
}

function splitPanel(tabId, sourceContainer, targetContainer, zone) {
    removeTabFromLayout(tabId);
    
    const newPanel = { type: 'panel', tabs: [tabId], activeTab: tabId, size: zone === 'top' || zone === 'bottom' ? 250 : 300 };
    
    function findAndSplit(node, parent, index) {
        if (node.type === 'panel') {
            const targetTabs = Array.from(targetContainer.querySelectorAll('.tab')).map(t => t.dataset.panelId);
            if (node.tabs.some(t => targetTabs.includes(t))) {
                const direction = (zone === 'left' || zone === 'right') ? 'horizontal' : 'vertical';
                const newNode = {
                    type: direction,
                    size: node.size,
                    children: zone === 'left' || zone === 'top' 
                        ? [newPanel, { ...node, size: null }]
                        : [{ ...node, size: null }, newPanel]
                };
                if (parent) {
                    parent.children[index] = newNode;
                } else {
                    Object.assign(layoutState, newNode);
                }
                return true;
            }
        }
        if (node.children) {
            for (let i = 0; i < node.children.length; i++) {
                if (findAndSplit(node.children[i], node, i)) return true;
            }
        }
        return false;
    }
    findAndSplit(layoutState, null, 0);
}

function removeTabFromLayout(tabId) {
    function remove(node) {
        if (node.type === 'panel') {
            const idx = node.tabs.indexOf(tabId);
            if (idx > -1) {
                node.tabs.splice(idx, 1);
                if (node.activeTab === tabId) {
                    node.activeTab = node.tabs[0] || null;
                }
            }
        }
        if (node.children) {
            node.children.forEach(remove);
        }
    }
    remove(layoutState);
}

function cleanupEmptyPanels() {
    function cleanup(node, parent, index) {
        if (node.children) {
            // Recursively clean children first
            for (let i = node.children.length - 1; i >= 0; i--) {
                cleanup(node.children[i], node, i);
            }
            // Remove empty children
            node.children = node.children.filter(child => {
                if (child.type === 'panel') return child.tabs.length > 0;
                if (child.children) return child.children.length > 0;
                return true;
            });
            // Collapse single-child containers
            if (node.children.length === 1) {
                const child = node.children[0];
                if (parent) {
                    parent.children[index] = { ...child, size: node.size };
                } else {
                    Object.assign(layoutState, child);
                }
            }
        }
    }
    cleanup(layoutState, null, 0);
}

// ============ RESIZERS ============
function initResizers() {
    let activeResizer = null, startPos = 0, startSizes = [], siblings = [], isVertical = false;
    
    document.querySelectorAll('.resizer').forEach(resizer => {
        resizer.addEventListener('mousedown', e => {
            e.preventDefault();
            activeResizer = resizer;
            isVertical = resizer.classList.contains('vertical');
            startPos = isVertical ? e.clientY : e.clientX;
            
            const parent = resizer.parentElement;
            siblings = Array.from(parent.children).filter(c => !c.classList.contains('resizer'));
            const idx = parseInt(resizer.dataset.index);
            startSizes = [
                isVertical ? siblings[idx-1].offsetHeight : siblings[idx-1].offsetWidth,
                isVertical ? siblings[idx].offsetHeight : siblings[idx].offsetWidth
            ];
            
            resizer.classList.add('active');
            document.body.style.cursor = isVertical ? 'row-resize' : 'col-resize';
            document.body.style.userSelect = 'none';
        });
    });
    
    document.addEventListener('mousemove', e => {
        if (!activeResizer) return;
        const idx = parseInt(activeResizer.dataset.index);
        const delta = (isVertical ? e.clientY : e.clientX) - startPos;
        const newSize1 = Math.max(150, startSizes[0] + delta);
        const newSize2 = Math.max(150, startSizes[1] - delta);
        
        if (isVertical) {
            siblings[idx-1].style.height = newSize1 + 'px';
            siblings[idx-1].style.flex = 'none';
            siblings[idx].style.height = newSize2 + 'px';
            siblings[idx].style.flex = 'none';
        } else {
            siblings[idx-1].style.width = newSize1 + 'px';
            siblings[idx-1].style.flex = 'none';
            siblings[idx].style.width = newSize2 + 'px';
            siblings[idx].style.flex = 'none';
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (activeResizer) {
            activeResizer.classList.remove('active');
            activeResizer = null;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            updateLayoutSizes();
            resizeCanvas();
        }
    });
}

function updateLayoutSizes() {
    function walk(node, el) {
        if (!el) return;
        if (node.type === 'panel') {
            const w = el.style.width, h = el.style.height;
            if (w && w !== 'auto') node.size = parseInt(w);
            else if (h && h !== 'auto') node.size = parseInt(h);
            else if (el.style.flex === '1') node.size = null;
        } else if (node.children) {
            const childEls = Array.from(el.children).filter(c => !c.classList.contains('resizer'));
            node.children.forEach((child, i) => walk(child, childEls[i]));
        }
    }
    walk(layoutState, document.getElementById('workspace').firstChild);
    saveLayout();
}

function maximizePanel(btn) {
    const container = btn.closest('.panel-container');
    container.classList.toggle('maximized');
    if (container.classList.contains('maximized')) {
        container.style.cssText = 'position:fixed;inset:50px 0 0 0;z-index:200;';
    } else {
        container.style.cssText = '';
    }
    setTimeout(resizeCanvas, 50);
}

// ============ CANVAS ============
function initCanvas() {
    canvas = document.getElementById('canvas');
    if (!canvas) return;
    ctx = canvas.getContext('2d');
    resizeCanvas();
    
    canvas.addEventListener('mousedown', e => { drawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
    canvas.addEventListener('mousemove', e => {
        if (!drawing) return;
        ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(e.offsetX, e.offsetY);
        ctx.strokeStyle = tool === 'eraser' ? '#1a1a2e' : penColor;
        ctx.lineWidth = tool === 'eraser' ? 20 : 2; ctx.lineCap = 'round'; ctx.stroke();
        [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    canvas.addEventListener('mouseup', () => { drawing = false; saveCanvasData(); });
    canvas.addEventListener('mouseleave', () => { drawing = false; });
    
    const saved = localStorage.getItem('canvasData');
    if (saved) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = saved; }
}

function resizeCanvas() {
    if (!canvas) return;
    const container = canvas.parentElement;
    if (!container) return;
    const r = container.getBoundingClientRect();
    const savedData = canvas.toDataURL();
    canvas.width = r.width || 400;
    canvas.height = r.height || 200;
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0, 0);
    img.src = savedData;
}

function saveCanvasData() { localStorage.setItem('canvasData', canvas.toDataURL()); }
function setTool(t, btn) { tool = t; btn.closest('.wb-toolbar').querySelectorAll('.wb-tool').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
function setColor(c, btn) { penColor = c; tool = 'pen'; btn.closest('.wb-toolbar').querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); localStorage.removeItem('canvasData'); }
function askAboutCanvas() { askAI('Help me understand what I drew on the whiteboard'); }

// ============ DATA ============
async function loadData() { try { const r = await fetch('papers.json'); if (r.ok) { const d = await r.json(); allPapers = d.papers || []; } } catch(e) { allPapers = getSamplePapers(); } renderTabs(); filterPapers(); }
function getSamplePapers() { return [
    { id: '2412.01', title: 'Scaling Open-Ended Reasoning to Predict the Future', authors: 'Nikhil Chandak, Shashwat Goel', pubDateISO: '2025-12-31', score: 9, tags: ['cs.AI'], abstract: 'Novel approach...', pdf_link: 'https://arxiv.org/pdf/2412.01.pdf', link: 'https://arxiv.org/abs/2412.01' },
    { id: '2412.02', title: 'Can We Trust AI Explanations?', authors: 'Deep Mehta', pubDateISO: '2025-12-25', score: 9, tags: ['cs.AI'], abstract: 'Chain-of-thought...', pdf_link: 'https://arxiv.org/pdf/2412.02.pdf', link: 'https://arxiv.org/abs/2412.02' },
    { id: '2412.03', title: 'DiffThinker: Multimodal Reasoning with Diffusion', authors: 'Zefeng He', pubDateISO: '2025-12-30', score: 8, tags: ['cs.CV'], abstract: 'DiffThinker...', pdf_link: 'https://arxiv.org/pdf/2412.03.pdf', link: 'https://arxiv.org/abs/2412.03' },
    { id: '2412.04', title: 'Taming Hallucinations in Video MLLMs', authors: 'Zhe Huang', pubDateISO: '2025-12-30', score: 8, tags: ['cs.CV'], abstract: 'Video...', pdf_link: 'https://arxiv.org/pdf/2412.04.pdf', link: 'https://arxiv.org/abs/2412.04' },
    { id: '2412.05', title: 'JavisGPT: Multi-modal LLM for Video', authors: 'Kai Liu', pubDateISO: '2025-12-28', score: 8, tags: ['cs.CV'], abstract: 'JavisGPT...', pdf_link: 'https://arxiv.org/pdf/2412.05.pdf', link: 'https://arxiv.org/abs/2412.05' },
]; }
function getToday() { return new Date().toISOString().split('T')[0]; }

function renderTabs() {
    const tabs = document.getElementById('tabs'); if (!tabs) return;
    const today = getToday(), all = [...allPapers, ...customPapers];
    tabs.innerHTML = `
        <div class="filter-tab ${currentTab==='today'?'active':''}" onclick="switchTab('today')">Today<span class="count">${allPapers.filter(p=>p.pubDateISO===today).length}</span></div>
        <div class="filter-tab ${currentTab==='all'?'active':''}" onclick="switchTab('all')">All<span class="count">${all.length}</span></div>
        <div class="filter-tab ${currentTab==='top'?'active':''}" onclick="switchTab('top')">üî• Top<span class="count">${all.filter(p=>p.score>=8).length}</span></div>
        <div class="filter-tab ${currentTab==='saved'?'active':''}" onclick="switchTab('saved')">üíæ<span class="count">${savedPapers.length}</span></div>
        <div class="filter-tab ${currentTab==='mine'?'active':''}" onclick="switchTab('mine')">üìÅ<span class="count">${customPapers.length}</span></div>`;
}

function switchTab(tab) { currentTab = tab; renderTabs(); filterPapers(); }

function filterPapers() {
    const searchEl = document.getElementById('search'), sortEl = document.getElementById('sort-select'), listEl = document.getElementById('papers-list');
    if (!listEl) return;
    const search = (searchEl?.value || '').toLowerCase(), sort = sortEl?.value || 'score-desc', today = getToday();
    let papers = currentTab === 'today' ? allPapers.filter(p => p.pubDateISO === today) : currentTab === 'all' ? [...allPapers, ...customPapers] : currentTab === 'top' ? [...allPapers, ...customPapers].filter(p => p.score >= 8) : currentTab === 'saved' ? [...allPapers, ...customPapers].filter(p => savedPapers.includes(p.id)) : customPapers;
    if (search) papers = papers.filter(p => p.title.toLowerCase().includes(search) || (p.authors||'').toLowerCase().includes(search));
    const [field, dir] = sort.split('-');
    papers.sort((a, b) => { let va = field === 'score' ? (a.score||0) : (a.pubDateISO||''), vb = field === 'score' ? (b.score||0) : (b.pubDateISO||''); return dir === 'desc' ? (vb > va ? 1 : -1) : (va > vb ? 1 : -1); });
    renderPapers(papers);
}

function renderPapers(papers) {
    const container = document.getElementById('papers-list'); if (!container) return;
    if (!papers.length) { container.innerHTML = '<div class="empty">No papers found</div>'; return; }
    container.innerHTML = papers.map(p => {
        const scoreClass = p.score >= 8 ? 'high' : p.score >= 6 ? 'medium' : 'low', isSaved = savedPapers.includes(p.id), isSelected = selectedPaper?.id === p.id;
        return `<div class="paper ${isSelected?'selected':''}" onclick="selectPaper('${p.id}')">
            <div class="paper-title">${p.title}</div>
            <div class="paper-meta"><span class="paper-date">üìÖ ${formatDate(p.pubDateISO)}</span><span>${p.authors||'Unknown'}</span><span class="paper-score ${scoreClass}">${p.score}/10</span></div>
            <div class="paper-actions">${p.pdf_link?`<button class="paper-btn primary" onclick="event.stopPropagation();openPDF('${p.id}')">üìÑ PDF</button>`:''}<button class="paper-btn ${isSaved?'saved':''}" onclick="event.stopPropagation();toggleSave('${p.id}')">${isSaved?'‚úì Saved':'Save'}</button><a class="paper-btn" href="${p.link}" target="_blank" onclick="event.stopPropagation()">‚Üó</a></div>
        </div>`;
    }).join('');
}

function formatDate(d) { if (!d) return '?'; const dt = new Date(d); return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
function selectPaper(id) { selectedPaper = [...allPapers, ...customPapers].find(p => p.id === id); const ctx = document.getElementById('chat-context'); if (ctx && selectedPaper) ctx.innerHTML = 'Discussing: <strong>' + selectedPaper.title + '</strong>'; filterPapers(); }

function openPDF(id) {
    selectedPaper = [...allPapers, ...customPapers].find(p => p.id === id); if (!selectedPaper?.pdf_link) return;
    const ph = document.getElementById('pdf-placeholder'), tb = document.getElementById('pdf-toolbar'), fr = document.getElementById('pdf-frame');
    if (ph) ph.style.display = 'none'; if (tb) tb.style.display = 'flex'; if (fr) { fr.style.display = 'block'; fr.src = selectedPaper.pdf_link; }
    const title = document.getElementById('pdf-title'), newtab = document.getElementById('pdf-newtab'), page = document.getElementById('pdf-page');
    if (title) title.textContent = selectedPaper.title; if (newtab) newtab.href = selectedPaper.pdf_link; if (page) page.href = selectedPaper.link;
    const ctx = document.getElementById('chat-context'); if (ctx) ctx.innerHTML = 'Discussing: <strong>' + selectedPaper.title + '</strong>';
    addMessage('ai', 'Opened "<strong>' + selectedPaper.title + '</strong>". What would you like to know?'); filterPapers();
}

function closePDF() { const ph = document.getElementById('pdf-placeholder'), tb = document.getElementById('pdf-toolbar'), fr = document.getElementById('pdf-frame'); if (ph) ph.style.display = ''; if (tb) tb.style.display = 'none'; if (fr) { fr.style.display = 'none'; fr.src = ''; } }
function toggleSave(id) { if (savedPapers.includes(id)) savedPapers = savedPapers.filter(x => x !== id); else savedPapers.push(id); localStorage.setItem('savedPapers', JSON.stringify(savedPapers)); renderTabs(); filterPapers(); }

function openAddModal() { document.getElementById('add-modal').classList.add('show'); }
function closeAddModal() { document.getElementById('add-modal').classList.remove('show'); }
function saveCustomPaper(e) {
    e.preventDefault(); const url = document.getElementById('add-url').value;
    customPapers.unshift({ id: 'custom-' + Date.now(), title: document.getElementById('add-title').value, link: url, pdf_link: url.includes('arxiv.org/abs/') ? url.replace('/abs/', '/pdf/') + '.pdf' : null, authors: document.getElementById('add-authors').value || 'Unknown', pubDateISO: document.getElementById('add-date').value || getToday(), score: parseInt(document.getElementById('add-score').value) || 7, tags: [], isCustom: true });
    localStorage.setItem('customPapers', JSON.stringify(customPapers)); closeAddModal(); document.querySelector('#add-modal form').reset(); switchTab('mine');
}

function askAI(text) { const input = document.getElementById('chat-input'); if (input) { input.value = text; sendMessage(); } }
async function sendMessage() {
    const input = document.getElementById('chat-input'), msg = input?.value.trim(); if (!msg || isTyping) return;
    if (!selectedPaper) { addMessage('ai', 'Please select a paper first.'); return; }
    addMessage('user', msg); if (input) input.value = ''; chatHistory.push({ role: 'user', content: msg });
    isTyping = true; const sendBtn = document.getElementById('send-btn'); if (sendBtn) sendBtn.disabled = true; const typingEl = showTyping();
    try {
        const r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg, paper: { title: selectedPaper.title, authors: selectedPaper.authors, abstract: selectedPaper.abstract, tags: selectedPaper.tags }, history: chatHistory.slice(-8) }) });
        if (r.ok) { const d = await r.json(); typingEl.remove(); addMessage('ai', d.response); chatHistory.push({ role: 'assistant', content: d.response }); } else throw new Error();
    } catch(e) { typingEl.remove(); const fb = getFallback(msg); addMessage('ai', fb); chatHistory.push({ role: 'assistant', content: fb }); }
    isTyping = false; if (sendBtn) sendBtn.disabled = false;
}
function getFallback(msg) { const p = selectedPaper, m = msg.toLowerCase(); if (m.includes('summar')) return '<strong>'+p.title+'</strong><br><br>'+(p.abstract?.slice(0,400)||'Open PDF.')+'<br><br>Score: '+p.score+'/10'; return 'Offline mode. "'+p.title+'": '+(p.abstract?.slice(0,200)||'Open PDF.')+'...'; }
function addMessage(role, content) { const c = document.getElementById('chat-messages'); if (!c) return; c.innerHTML += '<div class="msg '+role+'"><div class="msg-avatar">'+(role==='ai'?'ü§ñ':'üë§')+'</div><div class="msg-content">'+content+'</div></div>'; c.scrollTop = c.scrollHeight; }
function showTyping() { const c = document.getElementById('chat-messages'); if (!c) return document.createElement('div'); const el = document.createElement('div'); el.className = 'msg ai'; el.innerHTML = '<div class="msg-avatar">ü§ñ</div><div class="msg-content typing"><span></span><span></span><span></span></div>'; c.appendChild(el); c.scrollTop = c.scrollHeight; return el; }

function toggleHelp() { const h = document.getElementById('help-tip'); h.style.display = h.style.display === 'none' ? 'block' : 'none'; }

window.addEventListener('resize', () => setTimeout(resizeCanvas, 100));
</script>
</body>
</html>
