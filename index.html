<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Papers Daily</title>
    <style>
        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #21262d;
            --border: #30363d;
            --text: #e6edf3;
            --text2: #8b949e;
            --blue: #58a6ff;
            --green: #238636;
            --orange: #f0883e;
            --red: #da3633;
            --purple: #a371f7;
            --yellow: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
        
        .app { display: flex; height: 100vh; }
        
        .panel { display: flex; flex-direction: column; border-right: 1px solid var(--border); transition: width 0.3s, min-width 0.3s; overflow: hidden; }
        .panel:last-child { border-right: none; border-left: 1px solid var(--border); }
        .panel.collapsed { width: 0 !important; min-width: 0 !important; border: none; }
        
        .papers-panel { width: 400px; min-width: 400px; }
        .pdf-panel { flex: 1; min-width: 0; background: var(--bg2); }
        .chat-panel { width: 420px; min-width: 420px; }
        
        .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); flex-shrink: 0; }
        .panel-header h1 { font-size: 1.1em; }
        .panel-header h2 { font-size: 0.95em; display: flex; align-items: center; gap: 8px; }
        .toggle-btn { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
        .toggle-btn:hover { background: var(--border); color: var(--text); }
        
        .panel-tab { position: fixed; background: var(--bg2); border: 1px solid var(--border); padding: 10px 6px; cursor: pointer; z-index: 10; writing-mode: vertical-rl; font-size: 0.8em; border-radius: 0 6px 6px 0; }
        .panel-tab:hover { background: var(--bg3); }
        .panel-tab.left { left: 0; top: 50%; transform: translateY(-50%); }
        .panel-tab.right { right: 0; top: 50%; transform: translateY(-50%) rotate(180deg); }
        .panel-tab.hidden { display: none; }
        
        .search-box { width: 100%; padding: 10px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85em; margin: 10px 0; }
        .search-box:focus { outline: none; border-color: var(--blue); }
        .panel-content { padding: 0 14px; flex-shrink: 0; }
        
        .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg2); overflow-x: auto; flex-shrink: 0; }
        .tab { padding: 10px 12px; font-size: 0.75em; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
        .tab .count { background: var(--bg3); padding: 1px 6px; border-radius: 8px; font-size: 0.75em; margin-left: 4px; }
        .tab.active .count { background: var(--blue); color: white; }
        
        .papers-list { flex: 1; overflow-y: auto; }
        .paper { padding: 12px 14px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .paper:hover { background: var(--bg2); }
        .paper.selected { background: var(--bg3); border-left: 3px solid var(--blue); }
        .paper-title { font-size: 0.85em; font-weight: 600; margin-bottom: 5px; line-height: 1.4; }
        .paper-meta { font-size: 0.7em; color: var(--text2); display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 6px; }
        .paper-date { color: var(--orange); font-weight: 500; }
        .paper-score { padding: 2px 6px; border-radius: 8px; font-size: 0.65em; font-weight: 600; }
        .paper-score.high { background: var(--green); color: white; }
        .paper-score.medium { background: var(--blue); color: white; }
        .paper-score.low { background: var(--bg3); color: var(--text2); }
        .paper-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
        .tag { font-size: 0.6em; padding: 2px 6px; background: var(--bg3); border-radius: 6px; color: var(--text2); }
        .paper-actions { display: flex; gap: 5px; }
        .paper-btn { padding: 4px 8px; font-size: 0.65em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text2); cursor: pointer; text-decoration: none; }
        .paper-btn:hover { background: var(--border); color: var(--text); }
        .paper-btn.primary { background: var(--blue); border-color: var(--blue); color: white; }
        .paper-btn.saved { background: var(--green); border-color: var(--green); color: white; }
        
        .pdf-empty { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text2); text-align: center; }
        .pdf-header { padding: 10px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); flex-shrink: 0; }
        .pdf-title { font-size: 0.8em; font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px; }
        .pdf-actions { display: flex; gap: 8px; align-items: center; }
        .pdf-actions a { font-size: 0.7em; color: var(--blue); text-decoration: none; }
        .close-btn { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em; }
        .close-btn:hover { background: var(--red); border-color: var(--red); color: white; }
        .pdf-frame { flex: 1; border: none; background: #333; }
        
        /* Chat Panel */
        .ai-status { width: 8px; height: 8px; border-radius: 50%; }
        .ai-status.online { background: var(--green); animation: pulse 2s infinite; }
        .ai-status.offline { background: var(--red); }
        .ai-status.thinking { background: var(--yellow); animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        
        .chat-context { padding: 8px 14px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.75em; color: var(--text2); flex-shrink: 0; }
        .chat-context strong { color: var(--purple); }
        
        .chat-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 14px; }
        .msg { margin-bottom: 14px; display: flex; gap: 10px; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7em; flex-shrink: 0; }
        .msg.user .msg-avatar { background: var(--blue); }
        .msg.ai .msg-avatar { background: var(--purple); }
        .msg-body { flex: 1; max-width: calc(100% - 40px); }
        .msg-content { padding: 10px 12px; border-radius: 10px; font-size: 0.8em; line-height: 1.5; word-wrap: break-word; }
        .msg.user .msg-content { background: var(--blue); }
        .msg.ai .msg-content { background: var(--bg3); }
        .msg-content pre { background: var(--bg); padding: 8px; border-radius: 4px; overflow-x: auto; margin: 8px 0; font-size: 0.85em; }
        .msg-content code { background: var(--bg); padding: 2px 4px; border-radius: 3px; font-size: 0.9em; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px 12px; }
        .typing-indicator span { width: 6px; height: 6px; background: var(--text2); border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-3px)} }
        
        /* Whiteboard */
        .whiteboard-section { border-top: 1px solid var(--border); flex-shrink: 0; }
        .whiteboard-header { padding: 8px 14px; background: var(--bg2); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .whiteboard-header:hover { background: var(--bg3); }
        .whiteboard-header h3 { font-size: 0.8em; display: flex; align-items: center; gap: 6px; }
        .whiteboard-toggle { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 0.8em; }
        .whiteboard-content { display: none; padding: 10px 14px; background: var(--bg); max-height: 200px; }
        .whiteboard-content.show { display: block; }
        .whiteboard-textarea { width: 100%; height: 150px; background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Monaco', 'Menlo', monospace; font-size: 0.8em; padding: 10px; resize: none; }
        .whiteboard-textarea:focus { outline: none; border-color: var(--yellow); }
        .whiteboard-actions { display: flex; gap: 8px; margin-top: 8px; }
        .whiteboard-btn { padding: 4px 10px; font-size: 0.7em; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text2); cursor: pointer; }
        .whiteboard-btn:hover { background: var(--border); color: var(--text); }
        
        .chat-input-area { padding: 10px 14px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .quick-btns { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .quick-btn { padding: 4px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; font-size: 0.65em; cursor: pointer; color: var(--text2); }
        .quick-btn:hover { border-color: var(--purple); color: var(--text); }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 12px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.8em; resize: none; min-height: 40px; max-height: 120px; }
        .chat-input:focus { outline: none; border-color: var(--purple); }
        .chat-send { padding: 10px 14px; background: var(--purple); border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.8em; }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .api-key-notice { padding: 10px 14px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.75em; }
        .api-key-notice input { width: 100%; padding: 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.9em; margin-top: 6px; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg2); border-radius: 12px; padding: 24px; width: 90%; max-width: 480px; }
        .modal h2 { margin-bottom: 20px; font-size: 1.1em; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.8em; color: var(--text2); margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.9em; }
        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn { padding: 10px 18px; border-radius: 6px; font-size: 0.85em; cursor: pointer; border: none; }
        .btn-primary { background: var(--purple); color: white; }
        .btn-secondary { background: var(--bg3); color: var(--text); }
        
        .footer-actions { padding: 8px 14px; border-top: 1px solid var(--border); flex-shrink: 0; }
        .footer-actions button { width: 100%; padding: 8px; }
        
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text2); }
        .empty-state h3 { color: var(--text); margin-bottom: 8px; font-size: 1em; }
        
        @media (max-width: 1200px) { .chat-panel { width: 360px; min-width: 360px; } }
        @media (max-width: 1000px) { .papers-panel { width: 320px; min-width: 320px; } }
    </style>
</head>
<body>
<div class="app">
    <!-- Papers Panel -->
    <div class="panel papers-panel" id="papers-panel">
        <div class="panel-header">
            <h1>üî¨ AI Papers Daily</h1>
            <button class="toggle-btn" onclick="togglePanel('papers')">‚óÄ</button>
        </div>
        <div class="panel-content">
            <input type="text" class="search-box" id="search" placeholder="Search papers..." oninput="filterPapers()">
        </div>
        <div class="tabs" id="tabs"></div>
        <div class="papers-list" id="papers-list">
            <div class="empty-state">Loading...</div>
        </div>
        <div class="footer-actions">
            <button class="paper-btn" onclick="openAddModal()">‚ûï Add Paper</button>
        </div>
    </div>
    <div class="panel-tab left hidden" id="papers-tab" onclick="togglePanel('papers')">üìÑ Papers</div>
    
    <!-- PDF Panel -->
    <div class="panel pdf-panel collapsed" id="pdf-panel">
        <div class="pdf-header">
            <div class="pdf-title" id="pdf-title"></div>
            <div class="pdf-actions">
                <a href="#" id="pdf-link-new" target="_blank">New tab ‚Üó</a>
                <a href="#" id="pdf-link-page" target="_blank">Paper ‚Üó</a>
                <button class="close-btn" onclick="closePDF()">‚úï</button>
            </div>
        </div>
        <iframe class="pdf-frame" id="pdf-frame"></iframe>
    </div>
    
    <!-- Chat Panel -->
    <div class="panel chat-panel" id="chat-panel">
        <div class="panel-header">
            <h2><div class="ai-status online" id="ai-status"></div> Ask AI</h2>
            <button class="toggle-btn" onclick="togglePanel('chat')">‚ñ∂</button>
        </div>
        
        <!-- API Key Input (only if not set) -->
        <div class="api-key-notice" id="api-key-section" style="display:none;">
            <strong>üîë Enter Groq API Key for live AI:</strong>
            <input type="password" id="api-key-input" placeholder="gsk_..." onchange="saveApiKey()">
            <small style="color:var(--text2);display:block;margin-top:4px;">Free at <a href="https://console.groq.com" target="_blank" style="color:var(--blue)">console.groq.com</a></small>
        </div>
        
        <div class="chat-context" id="chat-context">Select a paper to start</div>
        
        <div class="chat-body">
            <div class="chat-messages" id="chat-messages">
                <div class="msg ai">
                    <div class="msg-avatar">ü§ñ</div>
                    <div class="msg-body">
                        <div class="msg-content">Hi! Open a paper's PDF and I'll help you understand it. I can explain concepts, summarize sections, or discuss the methodology.</div>
                    </div>
                </div>
            </div>
            
            <!-- Whiteboard Section -->
            <div class="whiteboard-section">
                <div class="whiteboard-header" onclick="toggleWhiteboard()">
                    <h3>üìù Whiteboard</h3>
                    <span class="whiteboard-toggle" id="whiteboard-toggle">‚ñ≤</span>
                </div>
                <div class="whiteboard-content" id="whiteboard-content">
                    <textarea class="whiteboard-textarea" id="whiteboard" placeholder="Your notes, math, code snippets...

Example:
- Key insight: attention mechanism
- Q = K = V in self-attention
- Complexity: O(n¬≤)

def attention(Q, K, V):
    scores = Q @ K.T / sqrt(d_k)
    return softmax(scores) @ V"></textarea>
                    <div class="whiteboard-actions">
                        <button class="whiteboard-btn" onclick="clearWhiteboard()">Clear</button>
                        <button class="whiteboard-btn" onclick="copyWhiteboard()">Copy</button>
                        <button class="whiteboard-btn" onclick="askAboutWhiteboard()">Ask AI about this</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="quick-btns">
                <span class="quick-btn" onclick="askAI('Summarize this paper briefly')">Summarize</span>
                <span class="quick-btn" onclick="askAI('What is the key contribution?')">Key contribution</span>
                <span class="quick-btn" onclick="askAI('Explain the methodology')">Method</span>
                <span class="quick-btn" onclick="askAI('What are the main results?')">Results</span>
                <span class="quick-btn" onclick="askAI('Limitations and future work?')">Limitations</span>
            </div>
            <div class="chat-input-row">
                <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask anything about this paper..." onkeydown="handleChatKeydown(event)" oninput="autoResize(this)"></textarea>
                <button class="chat-send" id="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
    <div class="panel-tab right hidden" id="chat-tab" onclick="togglePanel('chat')">ü§ñ AI</div>
</div>

<!-- Add Paper Modal -->
<div class="modal-overlay" id="add-modal" onclick="if(event.target===this)closeAddModal()">
    <div class="modal">
        <h2>‚ûï Add Paper</h2>
        <form onsubmit="saveCustomPaper(event)">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="add-title" required placeholder="Attention Is All You Need">
            </div>
            <div class="form-group">
                <label>arXiv / Paper URL *</label>
                <input type="url" id="add-url" required placeholder="https://arxiv.org/abs/1706.03762">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Authors</label>
                    <input type="text" id="add-authors" placeholder="Vaswani et al.">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="add-date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Score (1-10)</label>
                    <input type="number" id="add-score" min="1" max="10" placeholder="8">
                </div>
                <div class="form-group">
                    <label>Tags</label>
                    <input type="text" id="add-tags" placeholder="transformers, attention">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
            </div>
        </form>
    </div>
</div>

<script>
// === CONFIG ===
const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
const MODEL = 'llama-3.3-70b-versatile';

// === STATE ===
let allPapers = [];
let customPapers = JSON.parse(localStorage.getItem('customPapers') || '[]');
let savedPapers = JSON.parse(localStorage.getItem('savedPapers') || '[]');
let apiKey = localStorage.getItem('groqApiKey') || '';
let currentTab = 'today';
let selectedPaper = null;
let chatHistory = [];
let isTyping = false;
let whiteboardOpen = false;

// === INIT ===
function init() {
    // Check API key
    if (!apiKey) {
        document.getElementById('api-key-section').style.display = 'block';
        document.getElementById('ai-status').className = 'ai-status offline';
    }
    
    // Load whiteboard content
    document.getElementById('whiteboard').value = localStorage.getItem('whiteboard') || '';
    
    loadData();
}

function saveApiKey() {
    apiKey = document.getElementById('api-key-input').value.trim();
    if (apiKey) {
        localStorage.setItem('groqApiKey', apiKey);
        document.getElementById('api-key-section').style.display = 'none';
        document.getElementById('ai-status').className = 'ai-status online';
        addMessage('ai', 'üü¢ API key saved! I\'m now connected and ready to help.');
    }
}

// === DATA ===
async function loadData() {
    try {
        const res = await fetch('papers.json');
        const data = await res.json();
        allPapers = data.papers || [];
        renderTabs();
        filterPapers();
    } catch (e) {
        document.getElementById('papers-list').innerHTML = '<div class="empty-state"><h3>No papers loaded</h3><p>Add your own papers below</p></div>';
        renderTabs();
    }
}

// === PANELS ===
function togglePanel(panel) {
    const el = document.getElementById(panel + '-panel');
    const tab = document.getElementById(panel + '-tab');
    el.classList.toggle('collapsed');
    tab.classList.toggle('hidden');
}

function closePDF() {
    document.getElementById('pdf-panel').classList.add('collapsed');
    document.getElementById('pdf-frame').src = '';
}

// === WHITEBOARD ===
function toggleWhiteboard() {
    whiteboardOpen = !whiteboardOpen;
    document.getElementById('whiteboard-content').classList.toggle('show', whiteboardOpen);
    document.getElementById('whiteboard-toggle').textContent = whiteboardOpen ? '‚ñº' : '‚ñ≤';
}

function clearWhiteboard() {
    if (confirm('Clear whiteboard?')) {
        document.getElementById('whiteboard').value = '';
        localStorage.removeItem('whiteboard');
    }
}

function copyWhiteboard() {
    const text = document.getElementById('whiteboard').value;
    navigator.clipboard.writeText(text);
    alert('Copied to clipboard!');
}

function askAboutWhiteboard() {
    const notes = document.getElementById('whiteboard').value.trim();
    if (!notes) {
        alert('Write something in the whiteboard first');
        return;
    }
    askAI('Here are my notes/questions:\n\n' + notes + '\n\nCan you help me with this?');
}

// Save whiteboard on change
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('whiteboard')?.addEventListener('input', (e) => {
        localStorage.setItem('whiteboard', e.target.value);
    });
});

// === TABS ===
function getToday() { return new Date().toISOString().split('T')[0]; }

function isToday(dateStr) {
    if (!dateStr) return false;
    return dateStr.split('T')[0] === getToday();
}

function formatDate(dateStr) {
    if (!dateStr) return 'Unknown';
    try {
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } catch { return dateStr; }
}

function renderTabs() {
    const todayPapers = allPapers.filter(p => isToday(p.pubDateISO));
    const counts = {
        today: todayPapers.length || allPapers.length,
        'must-read': allPapers.filter(p => p.score >= 8).length,
        saved: savedPapers.length,
        'my-papers': customPapers.length
    };
    
    document.getElementById('tabs').innerHTML = [
        { id: 'today', label: 'Today', count: counts.today },
        { id: 'must-read', label: 'üî• Top', count: counts['must-read'] },
        { id: 'saved', label: 'üìö Saved', count: counts.saved },
        { id: 'my-papers', label: 'üìÅ Mine', count: counts['my-papers'] }
    ].map(t => `<div class="tab ${currentTab === t.id ? 'active' : ''}" onclick="switchTab('${t.id}')">${t.label}<span class="count">${t.count}</span></div>`).join('');
}

function switchTab(tab) {
    currentTab = tab;
    renderTabs();
    filterPapers();
}

// === PAPERS ===
function filterPapers() {
    const query = document.getElementById('search').value.toLowerCase();
    let papers = [];
    
    if (currentTab === 'today') {
        const todayPapers = allPapers.filter(p => isToday(p.pubDateISO));
        papers = todayPapers.length ? todayPapers : allPapers;
    } else if (currentTab === 'must-read') {
        papers = allPapers.filter(p => p.score >= 8);
    } else if (currentTab === 'saved') {
        papers = [...customPapers, ...allPapers].filter(p => savedPapers.includes(p.id));
    } else if (currentTab === 'my-papers') {
        papers = customPapers;
    }
    
    if (query) {
        papers = papers.filter(p => 
            p.title?.toLowerCase().includes(query) || 
            p.authors?.toLowerCase().includes(query)
        );
    }
    
    papers.sort((a, b) => (b.score || 0) - (a.score || 0));
    renderPapers(papers);
}

function renderPapers(papers) {
    const container = document.getElementById('papers-list');
    
    if (!papers.length) {
        container.innerHTML = '<div class="empty-state"><h3>No papers</h3></div>';
        return;
    }
    
    container.innerHTML = papers.map(p => {
        const scoreClass = p.score >= 8 ? 'high' : p.score >= 6 ? 'medium' : 'low';
        const isSaved = savedPapers.includes(p.id);
        const isSelected = selectedPaper?.id === p.id;
        const pdfUrl = getPdfUrl(p);
        const dateStr = formatDate(p.pubDateISO || p.pubDate);
        
        return `<div class="paper ${isSelected ? 'selected' : ''}" onclick="selectPaper('${p.id}')">
            <div class="paper-title">${p.title}</div>
            <div class="paper-meta">
                <span class="paper-date">üìÖ ${dateStr}</span>
                <span>${p.authors || 'Unknown'}</span>
                <span class="paper-score ${scoreClass}">${p.score || '?'}/10</span>
            </div>
            ${p.tags?.length ? `<div class="paper-tags">${p.tags.slice(0,3).map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
            <div class="paper-actions">
                ${pdfUrl ? `<button class="paper-btn primary" onclick="event.stopPropagation();openPDF('${p.id}')">üìÑ PDF</button>` : ''}
                <button class="paper-btn ${isSaved ? 'saved' : ''}" onclick="event.stopPropagation();toggleSave('${p.id}')">${isSaved ? '‚úì' : 'Save'}</button>
                <a href="${p.link}" target="_blank" class="paper-btn" onclick="event.stopPropagation()">‚Üó</a>
                ${p.isCustom ? `<button class="paper-btn" onclick="event.stopPropagation();deleteCustom('${p.id}')" style="color:var(--red)">üóë</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

function getPdfUrl(p) {
    if (p.pdf_link) return p.pdf_link;
    if (p.link?.includes('arxiv.org/abs/')) return p.link.replace('/abs/', '/pdf/') + '.pdf';
    return null;
}

function selectPaper(id) {
    selectedPaper = [...customPapers, ...allPapers].find(p => p.id === id);
    if (selectedPaper) {
        document.getElementById('chat-context').innerHTML = `üìÑ <strong>${selectedPaper.title}</strong>`;
        // Don't clear chat history, just add context message
        addMessage('ai', `Now discussing: "<strong>${selectedPaper.title}</strong>". What would you like to know?`);
    }
    filterPapers();
}

function openPDF(id) {
    selectPaper(id);
    if (!selectedPaper) return;
    
    const pdfUrl = getPdfUrl(selectedPaper);
    if (!pdfUrl) { alert('No PDF available'); return; }
    
    document.getElementById('pdf-panel').classList.remove('collapsed');
    document.getElementById('pdf-title').textContent = selectedPaper.title;
    document.getElementById('pdf-link-new').href = pdfUrl;
    document.getElementById('pdf-link-page').href = selectedPaper.link;
    document.getElementById('pdf-frame').src = pdfUrl;
}

function toggleSave(id) {
    if (savedPapers.includes(id)) savedPapers = savedPapers.filter(x => x !== id);
    else savedPapers.push(id);
    localStorage.setItem('savedPapers', JSON.stringify(savedPapers));
    renderTabs();
    filterPapers();
}

function deleteCustom(id) {
    if (!confirm('Delete?')) return;
    customPapers = customPapers.filter(p => p.id !== id);
    localStorage.setItem('customPapers', JSON.stringify(customPapers));
    renderTabs();
    filterPapers();
}

// === ADD PAPER ===
function openAddModal() { document.getElementById('add-modal').classList.add('show'); }
function closeAddModal() { document.getElementById('add-modal').classList.remove('show'); }

function saveCustomPaper(e) {
    e.preventDefault();
    const url = document.getElementById('add-url').value;
    customPapers.unshift({
        id: 'custom-' + Date.now(),
        title: document.getElementById('add-title').value,
        link: url,
        pdf_link: url.includes('arxiv.org/abs/') ? url.replace('/abs/', '/pdf/') + '.pdf' : null,
        authors: document.getElementById('add-authors').value || 'Unknown',
        pubDateISO: document.getElementById('add-date').value || getToday(),
        score: parseInt(document.getElementById('add-score').value) || 7,
        tags: document.getElementById('add-tags').value.split(',').map(t => t.trim()).filter(t => t),
        isCustom: true
    });
    localStorage.setItem('customPapers', JSON.stringify(customPapers));
    closeAddModal();
    document.querySelector('#add-modal form').reset();
    switchTab('my-papers');
}

// === LIVE AI CHAT ===
function handleChatKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function askAI(text) {
    document.getElementById('chat-input').value = text;
    sendMessage();
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg || isTyping) return;
    
    addMessage('user', msg);
    input.value = '';
    input.style.height = 'auto';
    
    // Add to history
    chatHistory.push({ role: 'user', content: msg });
    
    // Show typing
    isTyping = true;
    document.getElementById('ai-status').className = 'ai-status thinking';
    document.getElementById('send-btn').disabled = true;
    const typingId = showTyping();
    
    try {
        const response = await callGroqAPI(msg);
        removeTyping(typingId);
        addMessage('ai', response);
        chatHistory.push({ role: 'assistant', content: response });
    } catch (e) {
        removeTyping(typingId);
        addMessage('ai', `‚ö†Ô∏è ${e.message}. Using offline mode.`);
        // Fallback response
        const fallback = getFallbackResponse(msg);
        addMessage('ai', fallback);
    }
    
    isTyping = false;
    document.getElementById('ai-status').className = 'ai-status online';
    document.getElementById('send-btn').disabled = false;
}

async function callGroqAPI(userMessage) {
    if (!apiKey) {
        throw new Error('No API key set. Enter your Groq API key above');
    }
    
    // Build system prompt with paper context
    let systemPrompt = `You are an expert AI research assistant helping a user understand academic papers. Be concise but thorough. Use markdown for formatting. When explaining technical concepts, be clear and precise.`;
    
    if (selectedPaper) {
        systemPrompt += `\n\nCurrent paper being discussed:
Title: ${selectedPaper.title}
Authors: ${selectedPaper.authors || 'Unknown'}
Abstract: ${selectedPaper.abstract || 'Not available'}
Key Contribution: ${selectedPaper.key_contribution || 'Not extracted'}
Tags: ${selectedPaper.tags?.join(', ') || 'None'}
Score: ${selectedPaper.score}/10

Help the user understand this paper. Reference specific details when relevant.`;
    }
    
    // Build messages array with history
    const messages = [
        { role: 'system', content: systemPrompt },
        ...chatHistory.slice(-10), // Last 10 messages for context
        { role: 'user', content: userMessage }
    ];
    
    const response = await fetch(GROQ_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: MODEL,
            messages: messages,
            temperature: 0.7,
            max_tokens: 1500
        })
    });
    
    if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        if (response.status === 401) {
            throw new Error('Invalid API key');
        }
        throw new Error(error.error?.message || 'API request failed');
    }
    
    const data = await response.json();
    return data.choices[0]?.message?.content || 'No response generated';
}

function getFallbackResponse(msg) {
    const m = msg.toLowerCase();
    const p = selectedPaper;
    
    if (!p) return 'Please select a paper first by clicking on it or opening its PDF.';
    
    if (m.includes('summar')) {
        return `**${p.title}**\n\n${p.key_contribution || p.abstract?.slice(0,400) || 'No summary available.'}\n\n*Score: ${p.score}/10*`;
    }
    if (m.includes('key') || m.includes('contribution')) {
        return p.key_contribution || `The key contribution isn't extracted. Based on the title, this paper focuses on ${p.tags?.join(', ') || 'AI research'}.`;
    }
    if (m.includes('method')) {
        return `Check sections 3-4 of the PDF for methodology. Tags suggest this involves: ${p.tags?.join(', ') || 'machine learning techniques'}.`;
    }
    return `I'm in offline mode. For full AI responses, add your Groq API key. Meanwhile, I can tell you:\n\n**${p.title}**\n${p.abstract?.slice(0,300) || 'Open the PDF for details.'}...`;
}

function addMessage(role, content) {
    const container = document.getElementById('chat-messages');
    // Convert markdown-style formatting
    const formatted = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/\n/g, '<br>');
    
    container.innerHTML += `<div class="msg ${role}">
        <div class="msg-avatar">${role === 'ai' ? 'ü§ñ' : 'üë§'}</div>
        <div class="msg-body"><div class="msg-content">${formatted}</div></div>
    </div>`;
    container.scrollTop = container.scrollHeight;
}

function showTyping() {
    const id = 'typing-' + Date.now();
    document.getElementById('chat-messages').innerHTML += `<div class="msg ai" id="${id}">
        <div class="msg-avatar">ü§ñ</div>
        <div class="msg-body"><div class="typing-indicator"><span></span><span></span><span></span></div></div>
    </div>`;
    document.getElementById('chat-messages').scrollTop = 999999;
    return id;
}

function removeTyping(id) { document.getElementById(id)?.remove(); }

// === START ===
init();
</script>
</body>
</html>
